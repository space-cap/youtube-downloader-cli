# 크레딧 시스템 구현 계획

## 📋 개요

YouTube Downloader에 크레딧 기반 과금 시스템을 구현합니다. 사용자는 크레딧을 구매하여 다운로드에 사용하며, 화질에 따라 차등 크레딧이 소비됩니다.

---

## 🎯 목표

- 크레딧 기반 과금 시스템 구현
- 토스페이먼츠 결제 연동
- 사용자 인증 및 크레딧 관리
- UI/UX 업데이트

---

## 💳 크레딧 정책

### 크레딧 가격표

| 패키지 | 크레딧 | 가격 | 크레딧당 가격 | 할인율 |
|--------|--------|------|--------------|--------|
| 스타터 | 10 | ₩1,100 | ₩110 | - |
| 베이직 | 50 | ₩4,400 | ₩88 | 20% |
| 스탠다드 | 100 | ₩7,700 | ₩77 | 30% |
| 프리미엄 | 300 | ₩19,800 | ₩66 | 40% |
| 프로 | 1000 | ₩55,000 | ₩55 | 50% |

### 크레딧 소비표

| 작업 | 크레딧 | 예상 파일 크기 |
|------|--------|--------------|
| 360p 동영상 | 1 | ~50MB |
| 480p 동영상 | 2 | ~100MB |
| 720p 동영상 | 3 | ~200MB |
| 1080p 동영상 | 5 | ~500MB |
| 1440p (2K) | 8 | ~1GB |
| 2160p (4K) | 12 | ~2GB |
| 오디오 64-128kbps | 1 | ~30-60MB |
| 오디오 192-320kbps | 2 | ~90-120MB |

### 무료 크레딧

- **신규 가입**: 5 크레딧
- **친구 추천**: 추천인/피추천인 각 3 크레딧
- **일일 로그인**: 1 크레딧 (최대 주 3회)

---

## 🏗️ 시스템 아키텍처

### 기술 스택

- **백엔드**: FastAPI, SQLAlchemy, PostgreSQL
- **인증**: JWT (JSON Web Tokens)
- **결제**: 토스페이먼츠 API
- **프론트엔드**: 기존 HTML/CSS/JavaScript

### 데이터베이스 스키마

```sql
-- 사용자 테이블
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    credits INT DEFAULT 5,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 크레딧 거래 내역
CREATE TABLE credit_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    amount INT NOT NULL,
    type VARCHAR(50) NOT NULL,  -- 'purchase', 'bonus', 'usage', 'refund'
    description TEXT,
    balance_after INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 결제 내역
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    order_id VARCHAR(255) UNIQUE NOT NULL,
    amount INT NOT NULL,
    credits INT NOT NULL,
    status VARCHAR(50) NOT NULL,  -- 'pending', 'completed', 'failed', 'refunded'
    payment_key VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

-- 다운로드 내역
CREATE TABLE downloads (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    task_id UUID NOT NULL,
    video_url TEXT NOT NULL,
    video_title TEXT,
    quality VARCHAR(20) NOT NULL,
    credits_used INT NOT NULL,
    status VARCHAR(20) NOT NULL,  -- 'pending', 'downloading', 'completed', 'failed'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_credit_transactions_user_id ON credit_transactions(user_id);
CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_downloads_user_id ON downloads(user_id);
CREATE INDEX idx_downloads_task_id ON downloads(task_id);
```

---

## 📅 개발 로드맵

### Phase 1: 사용자 인증 시스템 (1주)

#### Day 1-2: 데이터베이스 설정
- [ ] PostgreSQL 설치 및 설정
- [ ] SQLAlchemy 모델 정의
- [ ] Alembic 마이그레이션 설정
- [ ] 데이터베이스 초기화

#### Day 3-4: 인증 API
- [ ] 회원가입 API (`POST /api/v1/auth/register`)
- [ ] 로그인 API (`POST /api/v1/auth/login`)
- [ ] JWT 토큰 발급 및 검증
- [ ] 비밀번호 해싱 (bcrypt)
- [ ] 사용자 정보 조회 API (`GET /api/v1/auth/me`)

#### Day 5: 인증 미들웨어
- [ ] JWT 인증 미들웨어
- [ ] 보호된 라우트 데코레이터
- [ ] 에러 처리

---

### Phase 2: 크레딧 관리 시스템 (1주)

#### Day 1-2: 크레딧 API
- [ ] 크레딧 잔액 조회 (`GET /api/v1/credits`)
- [ ] 크레딧 거래 내역 (`GET /api/v1/credits/history`)
- [ ] 크레딧 소비 계산 (`POST /api/v1/credits/estimate`)
- [ ] 크레딧 차감 로직

#### Day 3-4: 다운로드 통합
- [ ] 다운로드 전 크레딧 체크
- [ ] 다운로드 내역 저장
- [ ] 크레딧 자동 차감
- [ ] 실패 시 크레딧 환불

#### Day 5: 보너스 시스템
- [ ] 신규 가입 보너스
- [ ] 일일 로그인 보너스
- [ ] 추천 시스템 (선택사항)

---

### Phase 3: 결제 시스템 (1주)

#### Day 1-2: 토스페이먼츠 연동
- [ ] 토스페이먼츠 SDK 설치
- [ ] 결제 세션 생성 API (`POST /api/v1/payment/checkout`)
- [ ] 결제 승인 API (`POST /api/v1/payment/confirm`)
- [ ] 결제 실패 처리

#### Day 3-4: 웹훅 및 검증
- [ ] 결제 완료 웹훅 (`POST /api/v1/payment/webhook`)
- [ ] 크레딧 자동 충전
- [ ] 결제 검증 로직
- [ ] 중복 결제 방지

#### Day 5: 결제 관리
- [ ] 결제 내역 조회 (`GET /api/v1/payment/history`)
- [ ] 환불 처리 (선택사항)
- [ ] 결제 실패 알림

---

### Phase 4: 프론트엔드 UI (1주)

#### Day 1-2: 인증 UI
- [ ] 로그인 페이지
- [ ] 회원가입 페이지
- [ ] 로그아웃 기능
- [ ] 사용자 정보 표시

#### Day 3-4: 크레딧 UI
- [ ] Header에 크레딧 잔액 표시
- [ ] 크레딧 구매 페이지
- [ ] 패키지 카드 디자인
- [ ] 결제 플로우

#### Day 5: 다운로드 UI 업데이트
- [ ] 다운로드 전 크레딧 안내
- [ ] 크레딧 부족 시 충전 팝업
- [ ] 다운로드 내역 페이지
- [ ] 크레딧 거래 내역 페이지

---

### Phase 5: 테스트 및 배포 (3일)

#### Day 1: 테스트
- [ ] 단위 테스트
- [ ] 통합 테스트
- [ ] 결제 테스트 (샌드박스)
- [ ] 보안 테스트

#### Day 2: 문서화
- [ ] API 문서 업데이트
- [ ] 사용자 가이드 업데이트
- [ ] 결제 가이드 작성

#### Day 3: 배포
- [ ] 프로덕션 환경 설정
- [ ] 데이터베이스 마이그레이션
- [ ] 배포 및 모니터링

---

## 🔒 보안 고려사항

### 인증 보안
- 비밀번호 해싱 (bcrypt, cost factor 12)
- JWT 토큰 만료 시간 (1시간)
- Refresh Token (선택사항)
- HTTPS 필수

### 결제 보안
- 결제 금액 서버 검증
- 웹훅 서명 검증
- 중복 결제 방지
- PCI DSS 준수 (토스페이먼츠가 처리)

### 데이터 보안
- SQL Injection 방지 (SQLAlchemy ORM)
- XSS 방지
- CSRF 토큰
- Rate Limiting

---

## 📊 모니터링 및 분석

### 주요 지표
- 신규 가입자 수
- 크레딧 구매 전환율
- 평균 구매 금액
- 일일 활성 사용자 (DAU)
- 월간 활성 사용자 (MAU)
- 크레딧 소비 패턴

### 로깅
- 모든 결제 트랜잭션
- 크레딧 거래 내역
- 다운로드 내역
- 에러 로그

---

## 💰 예상 비용

### 개발 비용
- PostgreSQL 호스팅: ₩10,000/월
- 토스페이먼츠 수수료: 2.9% + ₩100/건
- SSL 인증서: 무료 (Let's Encrypt)

### 운영 비용
- 서버: ₩50,000/월
- 데이터베이스: ₩10,000/월
- 결제 수수료: 매출의 ~3%

---

## ⚠️ 법적 고려사항

### 필수 사항
- [ ] 이용약관 작성
- [ ] 개인정보 처리방침
- [ ] 환불 정책
- [ ] 사업자 등록
- [ ] 통신판매업 신고

### 권장 사항
- [ ] 법률 자문
- [ ] 저작권 면책 조항
- [ ] DMCA 대응 절차

---

## 🚀 다음 단계

1. **Phase 1 시작**: 사용자 인증 시스템
2. **이슈 생성**: GitHub Issue 생성
3. **개발 환경 설정**: PostgreSQL, 의존성 설치
4. **첫 번째 마일스톤**: 회원가입/로그인 완성

---

## 📚 참고 자료

- [FastAPI 인증 가이드](https://fastapi.tiangolo.com/tutorial/security/)
- [SQLAlchemy 문서](https://docs.sqlalchemy.org/)
- [토스페이먼츠 API](https://docs.tosspayments.com/)
- [JWT 베스트 프랙티스](https://tools.ietf.org/html/rfc8725)
